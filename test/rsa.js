const { assert, log } = require("console");
const path = require("path");
const Scalar = require("ffjavascript").Scalar;
const wasm_tester = require("circom_tester").wasm;

function bigintToArray(n, k, x) {
    let mod = BigInt(1);
    for (let idx = 0; idx < n; idx++) {
        mod *= BigInt(2);
    }

    const ret = [];
    let xTemp = x;
    for (let idx = 0; idx < k; idx++) {
        ret.push(xTemp % mod);
        xTemp /= mod; 
    }

    return ret;
}

async function testRsa(input1, input2, input3, real_result, circuit){
    let input = [bigintToArray(64, 64, input1), bigintToArray(64, 64, input2), input3];

    
    try {
        const w = await circuit.calculateWitness({ pubkey: input[0], signature: input[1], hashed: input[2], dummy: 0n }, true);

        if (!real_result) {
            throw new Error(`Expected failure for verification (${input1}, ${input2}), (${input3}, but it passed.`);
        }
    } catch (err) {
        if (real_result) {
            throw new Error(`Unexpected failure for verification (${input1}, ${input2}), (${input3}.`);
        } else {
            console.log(`Predicted failure for verification (${input1}, ${input2}), (${input3} correctly handled.`);
        }
    }
}

describe("Rsa test", function () {

    this.timeout(10000000);
    let circuit;

    before(async () => {
        circuit = await wasm_tester(path.join(__dirname, "circuits", "signatures", "rsa.circom"));
    });

    it("Ver correct signature", async function () {
        await testRsa(
            966794594591497630990088481255129604880529505246618696062343747145455065393674705114598076667258359356005514572334478957188346177028010499636282385734473716380778450928201782150183997504972720498734128988945956072853392567420449178778315154469364228850156277877617730838633610363142293482197447790862554008120283083960210701742382718239764058868630154633529904220260168261729662614495369252589036291591059937269196420405635305282020890965765304286680856991581735526193439041031344664645993385638717069036768408215375049411467164122402608028363079733269180580880098061342301259842529311440896014390650876505481647852705064424018926676904870942307384562470317147378366777183112610822895615467212219358220611950062255437816492328521659768572936524474691990713603393130831862719025646189071742939942750644664353239091806387745377740848513382672240661555946733821625169396600253297126949785378582501346758979733263371087563160747896890383177417914329825944507512769402557973024901097255753830686229175483653832706609821896780204716188892090640849213558019825354210821487942835376504255524141897310347165197580901560489185033767396691353463343373458656862087494259031260151917669425342578539820653256047795544215937781876532375534962728937n, 
            34118299562523804488551656142956942464585783285083000844654139273861656006043545689066745181442377327066538632100756389464106880981972177047329716135909755029349939508661955945210939082632478014354942412312577466888066663475002406216989529805371967864368058870135617832697476637593381663381684795853714927291118876314130746786016823218440982225886642540213199724600798614435851255427499585409232534392202189960415086724246504279514224093737383004462122867679121668499466841765028196175579847796626172891377947174459839608721667487663546353768149548280855824926695772961107210126873019648207366251553577620882537777677793349515596127066098941913120967970463912953064394436642437854387371503809157816370528804280739464667362765619447902493612978962735585035372143610144686308227651731453581699079083030547894526659444129516131308830810304620885827702156887170132173763931253564169803618983842970860730358617640646094154396050573524376546458979991791283887085118505982641599523218670245503856218311961365848090146240486484059162362244808969611853705058428025104822705416546694445663580550375338187438380242455208942810794721168486888504657843900954273451635138238712337837499130404276669326154227739089056711258700923106331039489336314n,
            ["0","0","0","1","0","0","0","0","1","0","0","0","1","0","0","1","0","1","0","1","0","1","0","0","1","0","1","1","0","1","0","1","1","1","1","1","0","0","1","0","1","1","1","0","1","1","0","0","0","0","0","0","0","0","0","1","1","1","0","1","0","0","1","0","0","1","1","0","0","0","1","1","0","0","0","0","0","1","0","0","0","1","0","0","1","0","1","0","0","0","0","1","0","1","0","1","0","1","0","1","1","1","1","1","0","0","1","1","0","0","1","0","1","0","0","0","0","1","1","0","0","0","1","1","1","0","1","0","1","0","1","1","1","1","0","0","0","1","0","0","1","0","0","0","0","0","0","0","0","1","0","0","0","1","1","0","1","0","0","1","0","1","1","1","1","0","1","0","1","1","1","0","0","1","0","0","1","0","1","0","0","1","1","0","1","0","1","1","1","0","0","1","1","0","0","1","1","1","1","0","1","0","0","1","1","0","1","0","0","0","1","0","1","1","0","1","1","0","0","0","0","1","0","0","1","1","1","0","1","0","0","1","0","1","0","1","1","0","1","0","0","1","0","0","0","0","1","0","0","0","1","1","1","1","0","1"],
            true,
            circuit
        );
    });

    it("Ver incorrect signature, should handle failture", async function () {
        await testRsa(
            966794594591497630990088481255129604880529505246618696062343747145455065393674705114598076667258359356005514572334478957188346177028010499636282385734473716380778450928201782150183997504972720498734128988945956072853392567420449178778315154469364228850156277877617730838633610363142293482197447790862554008120283083960210701742382718239764058868630154633529904220260168261729662614495369252589036291591059937269196420405635305282020890965765304286680856991581735526193439041031344664645993385638717069036768408215375049411467164122402608028363079733269180580880098061342301259842529311440896014390650876505481647852705064424018926676904870942307384562470317147378366777183112610822895615467212219358220611950062255437816492328521659768572936524474691990713603393130831862719025646189071742939942750644664353239091806387745377740848513382672240661555946733821625169396600253297126949785378582501346758979733263371087563160747896890383177417914329825944507512769402557973024901097255753830686229175483653832706609821896780204716188892090640849213558019825354210821487942835376504255524141897310347165197580901560489185033767396691353463343373458656862087494259031260151917669425342578539820653256047795544215937781876532375534962728936n, 
            34118299562523804488551656142956942464585783285083000844654139273861656006043545689066745181442377327066538632100756389464106880981972177047329716135909755029349939508661955945210939082632478014354942412312577466888066663475002406216989529805371967864368058870135617832697476637593381663381684795853714927291118876314130746786016823218440982225886642540213199724600798614435851255427499585409232534392202189960415086724246504279514224093737383004462122867679121668499466841765028196175579847796626172891377947174459839608721667487663546353768149548280855824926695772961107210126873019648207366251553577620882537777677793349515596127066098941913120967970463912953064394436642437854387371503809157816370528804280739464667362765619447902493612978962735585035372143610144686308227651731453581699079083030547894526659444129516131308830810304620885827702156887170132173763931253564169803618983842970860730358617640646094154396050573524376546458979991791283887085118505982641599523218670245503856218311961365848090146240486484059162362244808969611853705058428025104822705416546694445663580550375338187438380242455208942810794721168486888504657843900954273451635138238712337837499130404276669326154227739089056711258700923106331039489336314n,
            ["0","0","0","1","0","0","0","0","1","0","0","0","1","0","0","1","0","1","0","1","0","1","0","0","1","0","1","1","0","1","0","1","1","1","1","1","0","0","1","0","1","1","1","0","1","1","0","0","0","0","0","0","0","0","0","1","1","1","0","1","0","0","1","0","0","1","1","0","0","0","1","1","0","0","0","0","0","1","0","0","0","1","0","0","1","0","1","0","0","0","0","1","0","1","0","1","0","1","0","1","1","1","1","1","0","0","1","1","0","0","1","0","1","0","0","0","0","1","1","0","0","0","1","1","1","0","1","0","1","0","1","1","1","1","0","0","0","1","0","0","1","0","0","0","0","0","0","0","0","1","0","0","0","1","1","0","1","0","0","1","0","1","1","1","1","0","1","0","1","1","1","0","0","1","0","0","1","0","1","0","0","1","1","0","1","0","1","1","1","0","0","1","1","0","0","1","1","1","1","0","1","0","0","1","1","0","1","0","0","0","1","0","1","1","0","1","1","0","0","0","0","1","0","0","1","1","1","0","1","0","0","1","0","1","0","1","1","0","1","0","0","1","0","0","0","0","1","0","0","0","1","1","1","1","0","1"],
            false,
            circuit
        );
    });
});